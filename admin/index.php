<?php$conf[path] ="../";$conf[module_path] ="../modules/";function GLOBAL_LOAD($filename){  return stripslashes(file_get_contents($filename));};function LOGIT($region, $fid, $module, $text, $data=""){    /*    global $conf;    $region = (int)$region;    $fid  = (int)$fid;    @session_start();    $SQL = "insert into $conf[DB_PREFIX]log(USERID, DATE, REGION, MODULE, DATA, FID, DESCR) "         ."VALUES ($_SESSION[manager_id], now(), $region, '$module', '$data', $fid ,'$text')";    mysql_query($SQL, $conf[DB]);        */};function GLOBAL_SAVE($filename, $data){  global $ADMINPATH;  if ($h = fopen("./data/$module$filename", 'w'))    {      fwrite($h, $data);      fclose ($h);    };};header ('Content-Type: text/html; charset="utf-8"');include_once ("../db.php");include_once ("protect.php");include_once ("core_module.php");include_once ("core_template.php");include_once ("core_update.php");include_once ("core_regions.php");$regions = new Regions();$UPDATE  = new Update;$modules = new Modules($conf);//error_reporting (E_ALL);$tmpdata[GET]=$_GET;$tmpdata[POST]=$_POST;$tmpdata[SESSION]=$_SESSION;$data= addslashes(serialize($tmpdata));/*$SQL = "insert into $conf[DB_PREFIX]log(USERID, DATE, REGION, MODULE, DATA, FID, DESCR) "."VALUES ($_SESSION[manager_id], now(), 0, '$_GET[module]', '$data', 0 ,'')";@mysql_query($SQL, $conf[DB]);*/if ($_GET[a]==""){  ?><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><TITLE>Easy Engine</TITLE></head><table border=1 height=1200px width=100%>  <tr>    <td width=14%><iframe height=100% wight=100% name="menuFrame" src="./?a=menu"></iframe></td>    <td width=100%><iframe height=100% style="width: 100%;" name="contentFrame"></iframe> </td>  </tr></table></html>  <?  die();};$ADMINPATH= ".";@session_start();setcookie(session_name(),session_id(),time()+3600*24*32);//$expiry = 14*12*60*30;//@setcookie(session_name(),session_id(), time()+$expiry, "/");//********************************************//*                Login Processing          *//********************************************if ($_GET[a]=="login"){  $password = $_POST[PASSWORD];  $SQL="SELECT * FROM $conf[DB_PREFIX]managers WHERE name='$_POST[login]' and password='$_POST[password]'";  $manager = mysql_fetch_assoc(mysql_query($SQL, $conf[DB]));  if($manager[group_id])  {    $_SESSION[login] = 1;    $_SESSION[manager_id]  = $manager[id];    $_SESSION[group_id]  = $manager[group_id];    $regions->reorder(0);    $regions->reorders(0);    header ("Location: command.php?a=collaps&id=register");  };  die();};if ($_GET[a]=="logout"){  session_unset();  session_destroy();  header ("Location: command.php?a=collaps&id=register");};if ($_SESSION[login]==1){  //authorized useruser  $LOGIN = "<a href=\"?a=logout\">Выйти</a>";  //List Of tools  $TITLE ="";  $HELP = "";  $PROPERTIESMENU="";  $MAINMODULE="";  $TOPMENU ="";  if ($_GET[a] =="") $_GET[a]="regions";  if ($_GET[s] =="") $_GET[s]="view";  $TOPMENU="<a href=\"?a=modules\">Модули</a> &nbsp;"  ."<a href=\"?a=users\">Пользователи</a> &nbsp;"  ."<a href=\"?a=properties\">Настройки</a> &nbsp;"  ."<a href=\"?a=regions\">Разделы</a> &nbsp;"  ."<a href=\"?a=templates\">Шаблоны</a> &nbsp;"  ."<a href=\"?a=statistics\">Статистика</a> &nbsp;"  ."<a href=\"?a=update\">Обновление</b></a> &nbsp;"  ."<a href=\"?a=bugs\">Сообщение об ошибках</b></a> &nbsp;"  ;  switch ($_GET[a])  {    case "menu":      echo file_get_contents('menucode.dat');      die();      break;    case "update":      if ($_GET[s]=="")      $_GET[s]="view";      switch ($_GET[s])      {        case "view":          $PROPERTIESMENU ="<font size=4>Операция:</font>"          ."<a href=\"?a=update&s=view\"><b>Просмотр доступных обновлений</b></a> &nbsp;"          ;          break;        case "doupdate":          $MAINMODULE = $UPDATE->doUpdate($_POST[serial]);          break;        case "updateee":          $MAINMODULE = $UPDATE->UpdateEE();          break;      };      break;        case "properties":          //*****************************************************************************          //            Properties          //*****************************************************************************          if ($_GET[s]=="")          $_GET[s]="view";          $PROPERTIESMENU ="<font size=4>Настройки:</font>"          //              ."<a href=\"?a=properties&s=view\"><b>Кеширование</b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=css\"><b>CSS сайта</b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=cssmenu\"><b>CSS меню</b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=JS\"><b>Встраеваемые коды</b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=optimize\"><b>Оптимизация Таблиц </b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=reorder\"><b>Переупорядочивание разделов</b></a> &nbsp;"          //              ."<a href=\"?a=properties&s=viewlog\"><b>Системный Протокол</b></a> &nbsp;"          ;          switch ($_GET[s]){			case "enablelog":				GLOBAL_SAVE('log','1');				header('location: index.php?a=properties&s=viewlog');				die();						break;			case "disablelog":				GLOBAL_SAVE('log','0');				header('location: index.php?a=properties&s=viewlog');				die();						break;            case "clear":              $SQL = "DELETE from $conf[DB_PREFIX]log";              $res = mysql_query($SQL, $conf[DB]) or die (mysql_error());              header ("Loacation: ?a=properties&s=viewlog");              break;            case "viewlog":				$z = GLOBAL_LOAD('./data/log');				if ($z){					$MAINMODULE .= '<a href="?a=properties&s=disablelog">Выключить</a><br>';								}else{					$MAINMODULE .= '<a href="?a=properties&s=enablelog">Включить</a><br>';				};              $SQL = "select * from $conf[DB_PREFIX]log ORDER BY ID DESC";              $res = mysql_query($SQL, $conf[DB]);              $MAINMODULE .= '<br><a href="?a=properties&s=clear">Clear!</a><br>';              $MAINMODULE .= '<table border=1><tr><td>User</td><td>Region</td><td>module</td><td>Action</td><td>date</td><td>data</td></tr>';              while ($LOG = mysql_fetch_assoc($res)){                $view="<a href=\"?a=properties&s=viewlogdata&id=$LOG[ID]\" target=_blank>view</a>";                //if ($LOG[DATA]=="")$tmp="";                ;                $SQL  = "SELECT * FROM $conf[DB_PREFIX]managers WHERE id = $LOG[USERID]";                $res2 = mysql_query($SQL, $conf[DB]);                $user = mysql_fetch_assoc($res2);                $tmp2="";                //***********                $sql = "SELECT * FROM `$conf[DB_PREFIX]regions` WHERE `ID`=$LOG[REGION]";                $res2= mysql_query($sql, $conf[DB]);                $region = mysql_fetch_assoc($res2);                $tmp3[] = array ("$region[TITLE]", $region[ID]);                while ($region[PARENT] != 0) {                  $SQL = "SELECT TITLE, ID, PARENT FROM $conf[DB_PREFIX]regions WHERE ID=$region[PARENT]";                  $res4= mysql_query($SQL, $conf[DB]);                  $region= mysql_fetch_assoc($res4);                  $tmp3[] = array ($region[TITLE], $region[ID]);                };                $tmp = array_reverse($tmp3);                foreach ($tmp as $reg) {                  $tmp2.= "-><a target=\"contentFrame\" href=\"index.php?a=regions&s=edit&id=$reg[1]\">$reg[0]</a>";                };                //***********                $MAINMODULE .= "<tr><td>$user[name]($LOG[USERID])</td><td>$tmp2 $LOG[REGION]</td><td>$LOG[MODULE]($LOG[FID])</td><td><b>$LOG[DESCR]</b></td><td>$LOG[DATE]</td><td>$view</td></tr>";                unset ($tmp2);                unset ($tmp3);              };              $MAINMODULE .= '</table>';              break;            case "viewlogdata":              $SQL = "select * from $conf[DB_PREFIX]log WHERE ID = $_GET[id]";              $res = mysql_query($SQL, $conf[DB]);              $LOG = mysql_fetch_assoc($res);              $MAINMODULE .= "<table border=1><tr><td>".$LOG[DATA]."</td></tr></table>";              break;            case "css":              $tID = $_GET[template];              if (!$tID)              die("template error");              include_once ("core_template.php");              $template = new Template($_GET[template]);              $css =& $template->Get("css");              //$css = file_get_contents("../main.css");              $MAINMODULE = "<center>"              ."CSS Saita<form name=form method=\"POST\" action =\"?a=properties&s=savecss&template=$_GET[template]\">"              ."<textarea name=\"CSS\" style=\"HEIGHT:460px;WIDTH:100%;\">$css</textarea><br>"              .'<INPUT type="submit" value="Принять" class="mainoption"></form>'              ;              break;            case "savecss":              $tID = $_GET[template];              if (!$tID)              die("template error");              include_once ("core_template.php");              $template = new Template($_GET[template]);              $template->Set('css', $_POST[CSS]);              $template->Save();              header("Location: ?a=properties&s=css&template=$_GET[template]");              break;            case "view":              $HELP = "Время жизни указывается в минутах.";              $MAINMODULE = "<center>"              .'<form name=form method="POST" action ="?a=properties&s=savecache" >'              .'Время жизни страниц: <INPUT type="text" name="page" value="' . $conf[filecache] .'"><br>'              .'Время жизни файлов: <INPUT type="text" name="file" value="' . $conf[filecache] .'"><br>'              .'<INPUT type="submit" value="Принять" class="mainoption"></form>'              ;              break;            case "JS":              $settings = new Templater("../config.dat");              $dmenu =& $settings->Get("dmenu");              $vmenu =& $settings->Get("vmenu");              $dJS  =& $settings->Get("dJS");              $dstat=& $settings->Get("dstat");              $base=& $settings->Get("base");              if ($dmenu=="on") $c1 ="checked";              if ($vmenu=="on") $c0 ="checked";              if ($dJS=="on")   $c2 ="checked";              if ($dstat=="on") $c3="checked";              $MAINMODULE = ""              .'<form name=form method="POST" action ="?a=properties&s=saveJS" >'              ."<INPUT type=\"checkbox\" $c1 name=\"c1\">Меню<br>"              ."<INPUT type=\"checkbox\" $c0 name=\"c0\">Горизонтальное меню?<br>"              ."<INPUT type=\"checkbox\" $c2 name=\"c2\">Открытие окна<br>"              ."<INPUT type=\"checkbox\" $c3 name=\"c3\">Статистика:<br>"              ."<INPUT type=\"text\" size=30 name=\"base\" value=\"$base\">Базовый адрес<br>"              .'<INPUT type="submit" value="Принять" class="mainoption"></form>'              ;              break;            case "viewfiles":              $SQL = "select distinct `TYPE` from $conf[DB_PREFIX]files";              $res = mysql_query($SQL, $conf[DB]);              $MAINMODULE .= "Zagrushinie faily";              if ($res)              {                while ($file= mysql_fetch_assoc($res)) {                  $MAINMODULE .= "<a href=\"?a=properties&s=viewfiles&type=$file[TYPE]\"> $file[TYPE] </a> ";                }              };              $MAINMODULE .= "<br>";              $SQL = "select * from $conf[DB_PREFIX]files";              if ($_GET[type]!="")              {                $SQL = "select * from $conf[DB_PREFIX]files WHERE `TYPE`='$_GET[type]'";              };              $res = mysql_query($SQL, $conf[DB]);              if ($res)              {                while ($file = mysql_fetch_assoc($res))                {                  $MAINMODULE .= "<a href=\"?a=properties&s=deletefile&id=$file[ID]\">[X]</a> - <a href=\"../files/$file[ID]\">$file[NAME]</a>" . "<br>";                };              };              break;            case "deletefile":              $MAINMODULE = "<a href=\"?a=properties&s=commitdeletefile&id=$_GET[id]\">Удалить файл!</a>";              break;            case "commitdeletefile":              $SQL = "DELETE FROM $conf[DB_PREFIX]files WHERE ID = $_GET[id]";              mysql_query($SQL, $conf[DB]);              header ("location: ?a=properties&s=viewfiles");              break;            case "optimize":              // получаем список таблиц базы              $res = mysql_query("SHOW TABLES FROM $conf[DB_NAME]", @$conf[DB]);              if (mysql_num_rows($res) > 0)              {                while ($row = mysql_fetch_row($res))                {                  if (strpos($row[0], $conf[DB_PREFIX]) === 0)                  $tabs[] = $row[0];                };                $MAINMODULE .='<table border=1>';                $MAINMODULE .= "<tr><td>asd</td><td>Таблица</td><td>Починка</td><td>Оптимизация</td></tr>";                foreach ($tabs as $table)                {                  $SQL = "ANALYZE TABLE $table EXTENDED";                  $res = mysql_query($SQL, $conf[DB]);                  $data = mysql_fetch_assoc($res);                  $msg0=$data[Msg_text];                  $SQL = "REPAIR TABLE $table EXTENDED";                  $res = mysql_query($SQL, $conf[DB]);                  $data = mysql_fetch_assoc($res);                  $msg2=$data[Msg_text];                  $SQL = "OPTIMIZE TABLE $table";                  $res = mysql_query($SQL, $conf[DB]);                  $data = mysql_fetch_assoc($res);                  $msg1=$data[Msg_text];                  $MAINMODULE .= "<tr><td>$table</td><td>$msg0</td><td>$msg1</td><td>$msg2</td></tr>";                };                $MAINMODULE .="</table>";              };              break;            case "saveJS":              $settings = new Templater("../config.dat");              $settings->Set("dmenu", $_POST[c1]);              $settings->Set("base", $_POST[base]);              $settings->Set("dstat", $_POST[c3]);              $settings->Set("dJS", $_POST[c2]);              $settings->Set("vmenu", $_POST[c0]);              $settings->Set("dmenu", $_POST[c1]);              $settings->save();              header("Location: ?a=properties&s=JS");              break;            case "savecssmenu":              if ($h = fopen("../menu.css", 'w')){                fwrite($h, stripslashes($_POST[CSS]));              };              header("Location: ?a=properties&s=cssmenu");              break;            case "savecache":              if ($h = fopen("../config.php", 'w'))              {                fwrite($h, "<?\r\n");                fwrite($h, "\$conf[pagecache] = ". (int)($_POST[page]).";\r\n");                fwrite($h, "\$conf[filecache] = ". (int)($_POST[file]).";\r\n");                fwrite($h, "include (\"db.php\");\r\n");                fwrite($h, "include (\"get_vars.php\");\r\n");                fwrite($h, "?". ">");                fclose ($h);              };              header("Location: ?a=properties");              break;          };          break;            case "users":              //*****************************************************************************              //            USERS              //*****************************************************************************              $PROPERTIESMENU ="<font size=4>Управление Пользователями:</font>"              //          ."<a href=\"?a=users&s=addgroup\">Добавить группу</a> &nbsp;"              //          ."<a href=\"?a=users&s=view\"><b>просмотреть группы</b></a> &nbsp;"              ."<a href=\"?a=users&s=viewusers&id=$_GET[id]\"><b>просмотреть Пользователей</b></a> &nbsp;"              ;              $id = $_GET[id];              if ($_GET[s]=="")              $_GET[s]="view";              switch ($_GET[s])              {                case "view":                  $MAINMODULE = "";                  $SQL = "SELECT * FROM `$conf[DB_PREFIX]accessgroups`";                  @$t_res =  mysql_query($SQL, $conf[DB]);                  while (@$row=mysql_fetch_assoc($t_res))                  {                    $MAINMODULE.="<a href=\"?a=users&s=edit&id=$row[ID]\" >$row[NAME]</A><br>\n";                  };                  break;                case "adduser":                  break;                case "addgroup":                  $MAINMODULE = '<form name = "forma" action = "?a=users&s=addgroupcommit" method = "post">'                  .'<input type="text" value="Название Новой Группы" name="title" size="45"><br>'                  .'<input type = "submit" value = "Принять" class = "mainoption">'                  .'</form>'                  ;                  break;                case "addusercommit":                  $a = md5(rand(0,10000));                  $pass=substr($a, 1, 6);                  $sql="INSERT INTO `$conf[DB_PREFIX]managers` (`name`, `password`, `group_id`) VALUES ('$_POST[name]', '$pass', $id)";                  mysql_query($sql, $conf[DB]);                  header("Location: ?a=users&s=viewusers&id=$_GET[id]");                  break;                case "deluser":                  $sql="delete from `$conf[DB_PREFIX]managers` WHERE id=$_GET[add] and group_id=$_GET[id]";                  $r = mysql_query($sql) or die (mysql_error());                  header("Location: ?a=users&s=viewusers&id=$_GET[id]");                  break;                case "delgroup":                  break;                case "addgroupcommit":                  $sql="INSERT INTO `$conf[DB_PREFIX]accessgroups` (`NAME`) VALUES ('$_POST[title]')";                  mysql_query($sql, $conf[DB]);                  $id=mysql_insert_id($conf[DB]);                  mysql_close($conf[DB]);                  header("Location: ?a=users&s=edit&id=$id");                  break;                case "viewusers":                  $sql="SELECT * FROM $conf[DB_PREFIX]managers WHERE group_id=$_GET[id]";                  $result=mysql_query($sql, $conf[DB]);                  $MAINMODULE = "<br>";                  while ($user=mysql_fetch_assoc($result))                  {                    $MAINMODULE .="<a href=\"JavaScript:DoConfirm('Вы действительно хотите удалить Данного Пользователя?','?a=users&s=deluser&id=$user[group_id]&add=$user[id]')\"><img src=\"images/del.gif\" border=0></a>"                    ;                    $MAINMODULE .="$user[name] - $user[password]<br>";                  };                  $MAINMODULE .='<hr>Добавить нового пользователя в данную группу';                  $MAINMODULE .= '<form name = "forma" action = "?a=users&s=addusercommit&id=' . $id .'" method = "post">'                  .'<input type="text" value="User Name" name="name" size="45"><br>'                  .'<input type = "submit" value = "Принять" class = "mainoption">'                  .'</form>'                  ;                  break;                case "edituser":                  break;                case "editcommit":                  $SQL = "SELECT * FROM $conf[DB_PREFIX]access";                  $res=mysql_query($SQL, $conf[DB]);                  while ($access=mysql_fetch_assoc($res)){                    $aid = $access[id];                    $SQL = "DELETE FROM $conf[DB_PREFIX]accessrights WHERE group_id=$_GET[id] and access_id=$access[id]";                    mysql_query($SQL, $conf[DB]);                    if ($_POST[$aid]=='on')                    {                      $SQL = "INSERT INTO $conf[DB_PREFIX]accessrights(group_id, access_id) values($_GET[id], $aid)";                      mysql_query($SQL, $conf[DB]);                    };                  };                  header("Location: ?a=users&s=edit&id=$_GET[id]");                  break;                case "edit":                  $MAINMODULE = "<form method=POST action=\"?a=users&s=editcommit&id=$_GET[id]\">";                  $SQL = "SELECT * FROM $conf[DB_PREFIX]access";                  $res=mysql_query($SQL, $conf[DB]);                  while ($access=mysql_fetch_assoc($res)){                    $SQL = "SELECT count(group_id) as `c` FROM $conf[DB_PREFIX]accessrights WHERE group_id=$_GET[id] and access_id=$access[id]";                    $res2=mysql_query($SQL, $conf[DB]);                    $c = mysql_fetch_assoc($res2);                    $c  = $c[c];                    $checked = "";                    if ((int)$c)                    $checked = "checked";                    //$MAINMODULE .= "<input type=checkbox name=\"$access[id]\" $checked>$access[description]($access[name])<br>";                  };                  $MAINMODULE .= "<INPUT type=\"submit\" value=\"Принять\" class=\"mainoption\">";                  $MAINMODULE .= '</form>';                  break;              };              break;                case "modules":                  $PROPERTIESMENU ="<font size=4>Управление модулями:</font>"                  //          ."<a href=\"?a=modules&s=view\">Просмотреть</a> &nbsp;"                  //          ."<a href=\"?a=modules&s=add\"><b>Добавить</b></a> &nbsp;"                  //          ."<a href=\"#\">(Загрузить)</a> &nbsp;"                  //          ."<a href=\"#\">(Удалить)</a> &nbsp;"                  ;                  //*****************************************************************************                  //            MODULES                  //*****************************************************************************                  $HELP = "Помощь пока неготова.";                  if ($_GET[s]=="")                  $_GET[s]="view";                  switch ($_GET[s])                  {                    case "install":                      //*****************************************************************************                      //            install                      //*****************************************************************************                      if (!$modules->modules["$_GET[name]"]->info[registrated])                      {                        $modules->modules["$_GET[name]"]->install();                      }                      header ("Location: ?a=modules&s=add");                      break;                    case "add":                      //*****************************************************************************                      //            Add                      //*****************************************************************************                      $HELP = "Для установки модуля щелкните по нему мышкой.<p/> Послу успешной установки Вам будет предоставленна возможность продолжить утановку других модулей.";                      $PROPERTIESMENU.="<br><br><font size=4>Модуль для установки:</font>";                      $MAINMODULE = $modules->getUnregistrated();                      break;                    case "view":                      //*****************************************************************************                      //            VIEW                      //*****************************************************************************                      $SQL = "SELECT * FROM `$conf[DB_PREFIX]modules`";                      $res =  mysql_query($SQL, $conf[DB]);                      while ($module=mysql_fetch_assoc($res))                      {                        $MAINMODULE .="<a target=_blank href=\"properties.php?module=$module[PATH]\">$module[NAME]</a><br>"                        ;                      };                      break;                    case "editproperties":                      //$module = new Module($_GET[m]);                      //$PROPERTIESMENU ="<font size=4>Редактирование модуля <b>". $module->name. "<b> :</font>"                      //;                      //include ("core_properties.php");                      //$properties = new properties_Editor($_GET[m]);                      //include("../modules/$_GET[m]/properties.php");                      break;                  };                  break;                    case "regions":                      //*****************************************************************************                      //            REGIONS                      //*****************************************************************************                      if ($_GET[s]=="")                      $_GET[s]="view";                      $PROPERTIESMENU ="<font size=4>Управление Разделами:</font>"                      //          ."<a href=\"?a=regions&s=view\"><b>Быстрый просмотр</b></a> &nbsp;"                      //          ."<a href=\"?a=regions&s=viewtotal\">Полный Просмотр</a> &nbsp;"                      ."<a href=\"?a=regions&s=add&id=$_GET[id]\">Добавить новый</a> &nbsp;"                      //          ."<a href=\"?a=regions&s=viewspecial\">Специальные разделы</a> &nbsp;"                      ."<a href=\"?a=regions&s=delete\">Удалить</a>&nbsp;"                      //          ."<a href=\"?a=regions&s=export&id=$_GET[id]\">Экспорт</a>&nbsp;"                      ."<a href=\"?a=regions&s=showreparent&id=$_GET[id]\">Переподчинить</a>&nbsp;"                      ;                      switch ($_GET[s])                      {                        case "view":                          $MAINMODULE = $regions->printshort();                          if ((int)$_GET[renew]!=0 || $_GET[renew]==="0"){                            $SQL = "SELECT * FROM $conf[DB_PREFIX]regions WHERE `ID` = $_GET[renew]";                            //die ($SQL);                            if (@$result = mysql_query($SQL, $conf[DB])){                              if ($region= mysql_fetch_assoc($result)){                                //javascript:expand(\'$engName\')                                $st="";                                if ($region[PARENT]!=0)                                $st="_$region[PARENT]";                                $MAINMODULE.="<script>window.parent.menuFrame.expand(\"regions$st\");</script>";                              }                            }                          }                          break;                        case "viewtotal":                          $MAINMODULE = $regions->printtotal();                          break;                        case "showreparent":                          $MAINMODULE = $regions->reparentlist($_GET[id]);                          break;                        case "reparent":                          $regions->setparent($_GET[id], $_GET[parent]);                          $MAINMODULE = "<h2>Готово!</h2>";                          break;                        case "export":                          $MAINMODULE = "<pre>" . $regions->export($_GET[id]) . "</pre>";                          break;                        case "setactive":                          $sql="SELECT * FROM `$conf[DB_PREFIX]blocks` WHERE `PARENTREGION`=$_GET[id] and `LOCATION`=$_GET[location]";                          $result=mysql_query($sql, $conf[DB]);                          while ($block=mysql_fetch_assoc($result))                          {                            if ($_POST["block$block[ID]"]=="on")                            {                              $sql="UPDATE `$conf[DB_PREFIX]blocks` SET `ACTIVE` = 1 WHERE `ID`=$block[ID]";                            }else{                              $sql="UPDATE `$conf[DB_PREFIX]blocks` SET `ACTIVE` = 0 WHERE `ID`=$block[ID]";                            };                            mysql_query($sql, $conf[DB]);                          };                          header("Location: ?a=regions&s=edit&id=$id");                          break;                        case "up":                          $regions->up($_GET[id]);                          header("Location: ?a=regions&s=view");                          die();                          break;                        case "down":                          $regions->down($_GET[id]);                          header("Location: ?a=regions&s=view");                          die();                          break;                        case "upblock":                          $regions->upblock($_GET[add]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "delblock":                          $regions->delblock($_GET[add]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "downblock":                          $regions->downblock($_GET[add]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "settitle":                          $regions->settitle($_GET[id]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "setkw":                          $regions->setkw($_GET[id]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "listparent":                          $PROPERTIESMENU .="<br><font size=4>Выберете раздел, котому будет подчинён выбраный Ваи раздел:</font>";                          $MAINMODULE = $regions->printlistparent($_GET[id]);                          break;                        case "setparent":                          $regions->setparent($_GET[id], $_GET[parent]);                          header("Location: ?a=regions&s=view");                          die();                          break;                        case "addblock":                          $regions->addblock($_GET[id], $_GET[location], $_POST[type]);                          header("Location: ?a=regions&s=edit&id=$_GET[id]");                          die();                          break;                        case "savetotal":                          $regions->updatetotal();                          header("Location: ?a=regions&s=viewtotal");                          die();                          break;                        case "viewspecial":                          $MAINMODULE = $regions->printspecial();                          break;                        case "edit":                          // if (CA("region_$_GET[id]"))                          //   die("Acces Denied");                          $MAINMODULE = $regions->edit($_GET[id]);                          break;                        case "editlink":                          $MAINMODULE = $regions->editlink($_GET[id]);                          break;                        case "fixlink":                          $MAINMODULE = $regions->fixlink($_GET[id]);                          break;                        case "delete":                          $PROPERTIESMENU .= "<br><font size=4>Укажите раздел, который Вы хотите удалить:</font>";                          if ((int)$_GET[id] == 0)                          {// Показать список разделов                            $MAINMODULE = $regions->printlistdelete();                            if ($_GET[renew]!="")                            {                              $st = "";                              if ($_GET[renew]!=0)                              $st="_$_GET[renew]";                              $MAINMODULE.="<script>window.parent.menuFrame.expand(\"regions$st\");</script>";                            }                          }else{                            header("Location: ?a=regions&s=checkdelete&id=$_GET[id]");                            die();                          };                          break;                        case "commitdelete":                          $PROPERTIESMENU .= "<br><font size=4>Вы действительно хотите удалить данный раздел?</font>";                          $SQL="SELECT * FROM `$conf[DB_PREFIX]regions` WHERE `ID`=$_GET[id]";                          $res=mysql_query($SQL, $conf[DB]);                          $reg=mysql_fetch_assoc($res);                          $PROPERTIESMENU .= "<br>(<small><b>$reg[TITLE]</b>)</small>";                          if ((int)$_GET[id] != 0)                          {                            $MAINMODULE = "<a href=\"?a=regions&s=dodelete&id=$_GET[id]\">Да</a>";                          };                          break;                        case "dodelete":                          if ((int)$_GET[id]!=0){                            $SQL="SELECT * FROM `$conf[DB_PREFIX]regions` WHERE `ID`=$_GET[id]";                            $res=mysql_query($SQL, $conf[DB]);                            $reg=mysql_fetch_assoc($res);                            $parent=$reg[PARENT];                            $sql="UPDATE $conf[DB_PREFIX]regions  SET `PARENT` = 0 WHERE PARENT=$_GET[id]";                            mysql_query($sql, $conf[DB]);                            $sql="DELETE FROM $conf[DB_PREFIX]regions WHERE ID=$_GET[id]";                            mysql_query($sql, $conf[DB]);                            $sql="DELETE FROM $conf[DB_PREFIX]access WHERE NAME = 'region_$_GET[id]'";                            mysql_query($sql, $conf[DB]);                          };                          header("Location: ?a=regions&s=delete&renew=$parent");                          die();                          break;                        case "addcommit":                          $id= (int)$_GET[id];                          $SQL="SELECT max(`ORDER`) as `maximum` FROM `$conf[DB_PREFIX]regions` WHERE `PARENT`=$id";                          $res=mysql_query($SQL, $conf[DB]);                          @$ord=mysql_fetch_assoc($res);                          @$order=0 + (int)$ord[maximum] + 1;                          $DESC =$conf[default_DESC];                          $KW = $conf[default_KW];                          $TITLE = $conf[default_TITLE];                          $sql="INSERT INTO $conf[DB_PREFIX]regions (TITLE, PARENT, TEMPLATE, `ORDER`, `KW`, `DESC`, `WEBTITLE`) VALUES ('$_POST[rTITLE]', $id, $_POST[template], $order, '$KW', '$DESC', '$TITLE');";                          mysql_query($sql, $conf[DB]);                          $newid = mysql_insert_id($conf[DB]);                          registerAccess("region_$newid", "$_POST[rTITLE]");                          $sql="INSERT INTO  $conf[DB_PREFIX]navigate_active values ($newid)";                          $res = mysql_query($sql, $conf[DB]) or die (mysql_error());                          $sql="INSERT INTO  $conf[DB_PREFIX]map_active values ($newid)";                          $res = mysql_query($sql, $conf[DB]) or die (mysql_error());                          header("Location: ?a=regions&s=view&renew=$newid");                          die();                          break;                        case "addspecial":                          $SQL="SELECT max(`ORDER`) as `maximum` FROM `$conf[DB_PREFIX]regions` WHERE `PARENT`=0";                          $res=mysql_query($SQL, $conf[DB]);                          @$ord=mysql_fetch_assoc($res);                          @$order=0 + (int)$ord[maximum] + 1;                          $DESC =$conf[default_DESC];                          $KW = $conf[default_KW];                          $TITLE = $conf[default_TITLE];                          $SQL="SELECT * FROM `$conf[DB_PREFIX]templates`";                          $res=mysql_query($SQL, $conf[DB]);                          @$template=mysql_fetch_assoc($res);                          $sql="SELECT * FROM $conf[DB_PREFIX]modules WHERE `PATH`='$_GET[module]'";                          $res=mysql_query($sql, $conf[DB]);                          @$module = mysql_fetch_assoc($res);                          $sql="INSERT INTO $conf[DB_PREFIX]regions (TITLE, PARENT, TEMPLATE, `ORDER`, `KW`, `DESC`, `WEBTITLE`, `SPECIAL`) VALUES ('Отображение $module[NAME]', 0, $template[ID], $order, '', '', '', '$_GET[module]');";                          mysql_query($sql, $conf[DB]);                          header ("Location: ?a=regions&s=viewspecial");                          die();                          break;                        case "add":                          $MAINMODULE = '<form name = form method = "POST" action = "?a=regions&s=addcommit&id=' .$_GET[id]. '">'                          .'<input type="text" size="40" value="Заголовок нового раздела" name = "rTITLE" class = "mainoption">'                          .'<select name = "template">'                          ;                          $sql="SELECT * FROM $conf[DB_PREFIX]templates";                          $result=mysql_query($sql, $conf[DB]);                          while ($row=mysql_fetch_assoc($result))                          {                            $tmpID = $row['ID'];                            $tmpTITLE=$row['NAME'];                            $MAINMODULE .="<option value=\"$tmpID\">$tmpTITLE</option>";                          };                          $MAINMODULE .='</select><input type="submit" value="Принять" class="mainoption"> </FORM> </center>';                          break;                      };                      break;                        case "statistics":                          //*****************************************************************************                          //            STATISTICS                          //*****************************************************************************                          break;                        case "bugs":                          if ($_GET[s]=="")                          $_GET[s]="view";                          switch ($_GET[s]){                            case "view":                              if ($_GET[id]==1)                              $MAINMODULE="<h1>Спасибо за сообщение!</h1>"                              ;                              $MAINMODULE.="<form method=POST action=\"?a=bugs&s=commit\">"                              ."<center><h3>Сообщите о неисправности.</h3></center><br>"                              ."<table>"                              ."<tr><td>Имя сервера</td><td><input type=text name=SNAME value=\"$_SERVER[SERVER_NAME]\"></td></tr>"                              ."<tr><td>Адрес, по которому произошла ошибка</td><td><input type=text name=NUM size=50 value=\"\"></td></tr>"                              ."</table>"                              ."<textarea rows=6 cols=50 name=TEXT>Описание неполадки</textarea>"                              ."<br><input type=submit value=\"Отправить\">"                              ."</form>"                              ;                              break;                            case "commit":                              $_headers .= "From: EasyEngine 2.6\n";                              $_headers .= "X-Sender: <error@lmm.ru>\n";                              $_headers .= "X-Mailer: PHP/mail()\n"; //mailer                              $_headers .= "X-Priority: 3\n"; //1 UrgentMessage, 3 Normal                              $_headers .= "Return-Path: <error@lmm.ru>\n";                              $_headers .= "Content-type: text/html; charset=utf-8\r\n";                              $_headers .= "cc: error@lmm.ru\n"; // CC to                              $_headers .= "bcc: error@lmm.ru";                              $txt = "Адрес Сервера: $_POST[SNAME]\n"                              ."Адрес Ошибки: $_POST[NUM]\n"                              ."Проблема: $_POST[TEXT]\n"                              ;                              mail("kkirsanov@gmail.com, menelay@lmm.ru", "Сообщение об ошибке EasyEngine 2.6", $txt, $_headers);                              header ("Location: ?a=bugs&id=1");                              die();                              break;                          };                          break;                            case "templates":                              //*****************************************************************************                              //            `TES                              //*****************************************************************************                              $HELP = "Помощь пока неготова.";                              ;                              if ($_GET[s]=="")                              $_GET[s]="view";                              $PROPERTIESMENU =""                              //          ."<a href=\"?a=templates&s=view\">просмотр</b></a> &nbsp;"                              ."<a href=\"?a=templates&s=add\"><b>Добавить новый c диска</b></a> &nbsp;"                              ."<a href=\"?a=templates&s=create\">Cоздать новый</a> &nbsp;"                              ."<a href=\"?a=templates&s=delete\">Удалить</a> &nbsp;"                              ;                              switch ($_GET[s])                              {                                case "view":                                  $templates = new Templates();                                  $MAINMODULE = $templates->getRegistrated();                                  break;                                case "edit":                                  $templates = new Templates();                                  $MAINMODULE = $templates->edit($_GET[template]);                                  break;                                case "update":                                  $templates = new Templates();                                  $templates->update($_GET[template], $_POST[skin], $_POST[count], $POST[meta]);                                  header("Location: ?a=templates&s=edit&template=$_GET[template]");                                  break;                                case "create":                                  $templates = new Templates();                                  $MAINMODULE = $templates->createondisk();                                  break;                                case "commitcreate":                                  $templates = new Templates();                                  $MAINMODULE = $templates->commitcreateondisk();                                  header("Location: ?a=templates&s=add");                                  die();                                  break;                                case "delete":                                  $templates = new Templates();                                  $MAINMODULE = $templates->del();                                  break;                                case "checkdelete":                                  //$MAINMODULE = $templates->del();                                  $PROPERTIESMENU .= "<br><font size=4>Вы действительно хотите удалить данный Шаблон  ?</font>";                                  if ((int)$_GET[id] != 0)                                  {                                    $MAINMODULE = "<a href=\"?a=templates&s=dodelete&id=$_GET[id]\">Да</a>";                                  };                                  break;                                case "dodelete":                                  //$MAINMODULE = $templates->del();                                  $SQL = "DELETE FROM $conf[DB_PREFIX]templates WHERE ID=$_GET[id]";                                  mysql_query($SQL, $conf[DB]);                                  header("Location: ?a=templates&s=view");                                  die();                                  break;                                case "backup":                                  $templates = new Templates();                                  echo $templates->backup($_GET[template]);                                  break;                                case "commitrestore":                                  $templates = new Templates();                                  echo $templates->commitrestore($_GET[template]);                                  break;                                case "restore":                                  $templates = new Templates();                                  echo $templates->restore($_GET[template]);                                  break;                                case "add":                                  $templates = new Templates();                                  $MAINMODULE = $templates->getUnregistrated();                                  break;                                case "install":                                  $templ = new Template($_GET[name]);                                  $templ->install();                                  header("Location: ?a=templates&s=add");                                  die();                                  break;                              };                              break;  };  $TOPMENU = "";  $MAIN = str_replace("%LOGIN%", $LOGIN, stripslashes(file_get_contents("maintemplate.dat")));  $MAIN = str_replace("%MENU%", $TOPMENU, $MAIN);  $MAIN = str_replace("%TITLE%", $TITLE, $MAIN);  $MAIN = str_replace("%HELP%", $HELP, $MAIN);  $MAIN = str_replace("%PROPERTIESMENU%", $PROPERTIESMENU, $MAIN);  $MAIN = str_replace("%MAIN%", $MAINMODULE, $MAIN);  echo $MAIN;}else{  if($_GET[a]=menu){    echo file_get_contents('menucode.dat');  };};?>